<!doctype html>
<html lang="bg" data-theme="dark">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" href="/assets/img/Historyaddress.bg2.png">
    <title>–ö–∞–ª–µ–Ω–¥–∞—Ä - –ê–¥—Ä–µ—Å—ä—Ç –Ω–∞ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞</title>
    <meta name="description" content="–í–∏–∂—Ç–µ —Ä–æ–∂–¥–µ–Ω–∏ –¥–Ω–∏ –∏ –≥–æ–¥–∏—à–Ω–∏–Ω–∏ –æ—Ç –∂–∏–≤–æ—Ç–∞ –Ω–∞ –∑–Ω–∞—á–∏–º–∏ –±—ä–ª–≥–∞—Ä—Å–∫–∏ –ª–∏—á–Ω–æ—Å—Ç–∏.">
    <script>
        (function() {
            try {
                var stored = localStorage.getItem('theme-preference');
                if (stored === 'system') stored = 'dark';
                var theme = (stored === 'dark' || stored === 'light') ? stored : 'dark';
                document.documentElement.setAttribute('data-theme', theme);
            } catch(e) {}
        })();
    </script>
    <link rel="stylesheet" href="assets/css/styles.css">
    <script defer src="assets/js/theme.js"></script>
    <script defer src="assets/js/transitions.js"></script>
    <style>
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .calendar-nav {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .calendar-nav button {
            min-width: 44px;
            padding: 0.75rem 1rem;
        }
        .calendar-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--fg);
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 2rem;
        }
        .calendar-day-header {
            text-align: center;
            padding: 1rem 0.5rem;
            font-weight: 700;
            color: var(--muted);
            font-size: 0.85rem;
            text-transform: uppercase;
        }
        .calendar-day {
            aspect-ratio: 1;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            position: relative;
            cursor: default;
            transition: all 0.3s ease;
            min-height: 80px;
        }
        .calendar-day.other-month {
            opacity: 0.3;
        }
        .calendar-day.today {
            border: 2px solid var(--accent-strong);
            box-shadow: 0 0 20px rgba(205, 133, 63, 0.3);
        }
        .calendar-day.has-events {
            cursor: pointer;
            background: rgba(205, 133, 63, 0.1);
        }
        .calendar-day.has-events:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-soft);
            background: rgba(205, 133, 63, 0.2);
        }
        .calendar-day-number {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
            color: var(--fg);
        }
        .calendar-events-indicator {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 0.25rem;
        }
        .event-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent-strong);
        }
        .event-dot.birth {
            background: #4CAF50;
        }
        .event-dot.death {
            background: #9E9E9E;
        }
        .events-list {
            margin-top: 2rem;
        }
        .event-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            transition: all 0.3s ease;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
        }
        .event-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-soft);
        }
        .event-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }
        .event-content {
            flex: 1;
        }
        .event-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--fg);
            margin-bottom: 0.25rem;
        }
        .event-date {
            color: var(--muted);
            font-size: 0.9rem;
        }
        .event-years {
            color: var(--accent-soft);
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 0.25rem;
        }
        @media (max-width: 768px) {
            .calendar-grid {
                gap: 4px;
            }
            .calendar-day {
                min-height: 60px;
                padding: 0.25rem;
            }
            .calendar-day-number {
                font-size: 0.9rem;
            }
            .calendar-day-header {
                font-size: 0.7rem;
                padding: 0.5rem 0.25rem;
            }
            .event-dot {
                width: 4px;
                height: 4px;
            }
        }
        /* Highlight when search result */
.calendar-day.highlighted {
    animation: pulse 1.5s ease-in-out 3;
}

@keyframes pulse {
    0%, 100% { 
        box-shadow: 0 0 0 0 rgba(205, 133, 63, 0.7);
    }
    50% { 
        box-shadow: 0 0 0 10px rgba(205, 133, 63, 0);
    }
}

/* SEARCH RESULTS STYLING */
.search-result-item {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.search-result-item:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-soft);
    background: rgba(205, 133, 63, 0.1);
}
.search-result-name {
    font-weight: 700;
    color: var(--fg);
    margin-bottom: 0.25rem;
}
.search-result-dates {
    font-size: 0.85rem;
    color: var(--muted);
}
.search-result-badge {
    background: rgba(205, 133, 63, 0.2);
    padding: 0.25rem 0.75rem;
    border-radius: 999px;
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--accent-strong);
}/* Highlight when search result */
.calendar-day.highlighted {
    animation: pulse 1.5s ease-in-out 3;
}

@keyframes pulse {
    0%, 100% { 
        box-shadow: 0 0 0 0 rgba(205, 133, 63, 0.7);
    }
    50% { 
        box-shadow: 0 0 0 10px rgba(205, 133, 63, 0);
    }
}

/* SEARCH RESULTS STYLING */
.search-result-item {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.search-result-item:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-soft);
    background: rgba(205, 133, 63, 0.1);
}
.search-result-name {
    font-weight: 700;
    color: var(--fg);
    margin-bottom: 0.25rem;
}
.search-result-dates {
    font-size: 0.85rem;
    color: var(--muted);
}
.search-result-badge {
    background: rgba(205, 133, 63, 0.2);
    padding: 0.25rem 0.75rem;
    border-radius: 999px;
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--accent-strong);
}
    </style>
</head>
<body>
    <header class="site-header">
        <a class="logo-link" href="index.html">
            <img src="assets/img/HistAdrLogo.png" alt="–ê–¥—Ä–µ—Å—ä—Ç –Ω–∞ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞" class="header-logo">
            <span class="logo-text">–ê–¥—Ä–µ—Å—ä—Ç –Ω–∞ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞</span>
        </a>
        <nav class="nav">
            <a href="index.html">–ù–∞—á–∞–ª–æ</a>
            <a href="map.html">–ö–∞—Ä—Ç–∞</a>
            <a href="addresses.html">–î–æ–º–æ–≤–µ</a>
            <a href="calendar.html">–ö–∞–ª–µ–Ω–¥–∞—Ä</a>
            <a href="about.html">–ó–∞ –ù–∞—Å</a>
        </nav>
        <button id="theme-toggle" class="theme-toggle" aria-label="Toggle dark mode"></button>
    </header>

    <main class="container">
        <h1 class="page-title gradient-text">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä –Ω–∞ —Å—ä–±–∏—Ç–∏—è—Ç–∞</h1>
        
        <!-- SEARCH BAR -->
        <div style="margin-bottom: 1.5rem;">
            <input 
                type="text" 
                id="searchInput" 
                class="input" 
                placeholder="üîç –¢—ä—Ä—Å–∏ –ø–æ –∏–º–µ –Ω–∞ –ª–∏—á–Ω–æ—Å—Ç..." 
                style="width: 100%; max-width: 500px; font-size: 1rem;"
            >
            <div id="searchResults" style="margin-top: 0.5rem;"></div>
        </div>
        
        <div class="calendar-header">
            <div class="calendar-nav">
                <button id="prevMonth" class="theme-toggle">‚óÄ</button>
                <span class="calendar-title" id="monthYear">Loading...</span>
                <button id="nextMonth" class="theme-toggle">‚ñ∂</button>
            </div>
            <button id="todayBtn" class="theme-toggle">–î–Ω–µ—Å</button>
        </div>

        <div class="calendar-grid" id="calendarGrid"></div>

        <div class="events-list" id="eventsList"></div>
    </main>

    <footer class="site-footer">
        <p>¬© <span id="year"></span> –ê–¥—Ä–µ—Å—ä—Ç –Ω–∞ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞</p>
        <div class="footer-social">
            <a href="https://instagram.com/historyaddress.bg" target="_blank" rel="noopener noreferrer" class="social-link">
                üì∑ Instagram
            </a>
            <a href="mailto:historyaddressbg@gmail.com" class="social-link">
                üìß Email
            </a>
        </div>
        <p class="footer-links">
            <a href="privacy.html">–ü–æ–≤–µ—Ä–∏—Ç–µ–ª–Ω–æ—Å—Ç</a> | 
            <a href="terms.html">–£—Å–ª–æ–≤–∏—è</a> | 
            <a href="copyright.html">–ê–≤—Ç–æ—Ä—Å–∫–∏ –ø—Ä–∞–≤–∞</a>
        </p>
    </footer>

<script>
(function() {
    var apiBase = window.location.protocol === 'file:' ? 'http://localhost:3000' : window.location.origin;
    
    // Restore calendar state from sessionStorage
    var savedState = null;
    try {
        var saved = sessionStorage.getItem('calendar-state');
        if (saved) {
            savedState = JSON.parse(saved);
        }
    } catch(e) {
        console.error('Error loading calendar state:', e);
    }
    
    var currentDate = savedState && savedState.month && savedState.year 
        ? new Date(savedState.year, savedState.month - 1, 1)
        : new Date();
    var selectedDate = savedState ? savedState.selectedDate : null;
    var eventsData = {};
    var allPeopleData = []; // For search
    var searchTimeout;
    
    var monthNames = ['–Ø–Ω—É–∞—Ä–∏', '–§–µ–≤—Ä—É–∞—Ä–∏', '–ú–∞—Ä—Ç', '–ê–ø—Ä–∏–ª', '–ú–∞–π', '–Æ–Ω–∏', 
                      '–Æ–ª–∏', '–ê–≤–≥—É—Å—Ç', '–°–µ–ø—Ç–µ–º–≤—Ä–∏', '–û–∫—Ç–æ–º–≤—Ä–∏', '–ù–æ–µ–º–≤—Ä–∏', '–î–µ–∫–µ–º–≤—Ä–∏'];
    var dayNames = ['–ù–¥', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
    
    // Save calendar state whenever it changes
    function saveCalendarState() {
        try {
            sessionStorage.setItem('calendar-state', JSON.stringify({
                month: currentDate.getMonth() + 1,
                year: currentDate.getFullYear(),
                selectedDate: selectedDate
            }));
        } catch(e) {
            console.error('Error saving calendar state:', e);
        }
    }
    
    // Load all people with dates for search
    function loadAllPeople() {
        fetch(apiBase + '/api/calendar/all')
            .then(function(res) { return res.json(); })
            .then(function(data) {
                allPeopleData = data;
                console.log('Loaded', data.length, 'people for search');
            })
            .catch(function(err) {
                console.error('Error loading people:', err);
            });
    }
    
    // Search functionality
    document.getElementById('searchInput').addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        var query = e.target.value.trim().toLowerCase();
        
        if (query.length < 2) {
            document.getElementById('searchResults').innerHTML = '';
            return;
        }
        
        searchTimeout = setTimeout(function() {
            performSearch(query);
        }, 300);
    });
    
    function performSearch(query) {
        var words = query.split(/\s+/);
        var results = allPeopleData.filter(function(person) {
            var nameLower = person.name.toLowerCase();
            return words.every(function(word) {
                return nameLower.includes(word);
            });
        });
        
        displaySearchResults(results.slice(0, 5)); // Show max 5 results
    }
    
    function displaySearchResults(results) {
        var container = document.getElementById('searchResults');
        
        if (results.length === 0) {
            container.innerHTML = '<div style="color: var(--muted); font-size: 0.9rem;">–ù—è–º–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏</div>';
            return;
        }
        
        var html = '';
        results.forEach(function(person) {
            var dates = [];
            if (person.birth_date) dates.push('üéÇ ' + person.birth_date);
            if (person.death_date) dates.push('üïØÔ∏è ' + person.death_date);
            var datesText = dates.join(' ‚Ä¢ ');
            
            var count = (person.birth_date ? 1 : 0) + (person.death_date ? 1 : 0);
            var badge = count + ' ' + (count === 1 ? '–¥–∞—Ç–∞' : '–¥–∞—Ç–∏');
            
            html += '<div class="search-result-item" data-birth="' + (person.birth_date || '') + '" data-death="' + (person.death_date || '') + '" data-name="' + person.name + '">';
            html += '<div>';
            html += '<div class="search-result-name">' + person.name + '</div>';
            html += '<div class="search-result-dates">' + datesText + '</div>';
            html += '</div>';
            html += '<div class="search-result-badge">' + badge + '</div>';
            html += '</div>';
        });
        
        container.innerHTML = html;
        
        // Add click handlers
        var items = container.querySelectorAll('.search-result-item');
        items.forEach(function(item) {
            item.addEventListener('click', function() {
                var birthDate = this.dataset.birth;
                var deathDate = this.dataset.death;
                var name = this.dataset.name;
                
                // Jump to first available date
                var targetDate = birthDate || deathDate;
                if (targetDate) {
                    jumpToDate(targetDate, name);
                }
            });
        });
    }
    
    function jumpToDate(dateStr, personName) {
        var date = new Date(dateStr);
        currentDate = new Date(date.getFullYear(), date.getMonth(), 1);
        
        saveCalendarState();
        loadEvents();
        
        // Clear search
        document.getElementById('searchInput').value = '';
        document.getElementById('searchResults').innerHTML = '';
        
        // After calendar loads, highlight and show the date
        setTimeout(function() {
            var dateKey = String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');
            selectedDate = dateKey;
            saveCalendarState();
            showEventsForDate(dateKey);
            
            // Highlight the day with animation
            highlightDay(date.getDate());
            
            // Scroll to events list
            setTimeout(function() {
                document.getElementById('eventsList').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }, 200);
    }
    
    function highlightDay(day) {
        var cells = document.querySelectorAll('.calendar-day');
        cells.forEach(function(cell) {
            var num = cell.querySelector('.calendar-day-number');
            if (num && parseInt(num.textContent) === day && !cell.classList.contains('other-month')) {
                cell.classList.add('highlighted');
                setTimeout(function() {
                    cell.classList.remove('highlighted');
                }, 4500); // 3 pulses * 1.5s
            }
        });
    }
    
    function loadEvents() {
        var month = currentDate.getMonth() + 1;
        var year = currentDate.getFullYear();
        
        // Save state when loading new month
        saveCalendarState();
        
        fetch(apiBase + '/api/calendar?month=' + month + '&year=' + year)
            .then(function(res) { return res.json(); })
            .then(function(data) {
                eventsData = data;
                renderCalendar();
                
                // Restore selected date if it exists
                if (selectedDate) {
                    showEventsForDate(selectedDate);
                }
            })
            .catch(function(err) {
                console.error('Error loading events:', err);
            });
    }
    
    function renderCalendar() {
        var grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';
        
        // Day headers
        dayNames.forEach(function(day) {
            var header = document.createElement('div');
            header.className = 'calendar-day-header';
            header.textContent = day;
            grid.appendChild(header);
        });
        
        var year = currentDate.getFullYear();
        var month = currentDate.getMonth();
        var firstDay = new Date(year, month, 1).getDay();
        var daysInMonth = new Date(year, month + 1, 0).getDate();
        var daysInPrevMonth = new Date(year, month, 0).getDate();
        
        var today = new Date();
        var isCurrentMonth = today.getMonth() === month && today.getFullYear() === year;
        
        // Previous month days
        for (var i = firstDay - 1; i >= 0; i--) {
            var day = daysInPrevMonth - i;
            var cell = createDayCell(day, true, false);
            grid.appendChild(cell);
        }
        
        // Current month days
        for (var day = 1; day <= daysInMonth; day++) {
            var isToday = isCurrentMonth && day === today.getDate();
            var cell = createDayCell(day, false, isToday);
            grid.appendChild(cell);
        }
        
        // Next month days
        var totalCells = grid.children.length - 7; // subtract headers
        var remainingCells = (Math.ceil(totalCells / 7) * 7) - totalCells;
        for (var day = 1; day <= remainingCells; day++) {
            var cell = createDayCell(day, true, false);
            grid.appendChild(cell);
        }
        
        document.getElementById('monthYear').textContent = monthNames[month] + ' ' + year;
    }
    
    function createDayCell(day, otherMonth, isToday) {
        var cell = document.createElement('div');
        cell.className = 'calendar-day';
        if (otherMonth) cell.className += ' other-month';
        if (isToday) cell.className += ' today';
        
        var dateKey = formatDateKey(currentDate.getFullYear(), currentDate.getMonth() + (otherMonth ? (day > 15 ? -1 : 1) : 0), day);
        var events = eventsData[dateKey] || [];
        
        if (events.length > 0 && !otherMonth) {
            cell.className += ' has-events';
            cell.onclick = function() {
                selectedDate = dateKey;
                saveCalendarState();
                showEventsForDate(dateKey);
            };
        }
        
        var number = document.createElement('div');
        number.className = 'calendar-day-number';
        number.textContent = day;
        cell.appendChild(number);
        
        if (events.length > 0) {
            var indicator = document.createElement('div');
            indicator.className = 'calendar-events-indicator';
            events.forEach(function(event) {
                var dot = document.createElement('div');
                dot.className = 'event-dot ' + event.type;
                indicator.appendChild(dot);
            });
            cell.appendChild(indicator);
        }
        
        return cell;
    }
    
    function formatDateKey(year, month, day) {
        return String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
    }
    
    function showEventsForDate(dateKey) {
        var events = eventsData[dateKey] || [];
        var listEl = document.getElementById('eventsList');
        
        if (events.length === 0) {
            listEl.innerHTML = '';
            return;
        }
        
        var parts = dateKey.split('-');
        var displayDate = parts[1] + ' ' + monthNames[parseInt(parts[0]) - 1];
        
        var html = '<h2 style="margin-bottom: 1rem; color: var(--fg);">–°—ä–±–∏—Ç–∏—è –Ω–∞ ' + displayDate + '</h2>';
        
        events.forEach(function(event) {
            var icon = event.type === 'birth' ? 'üéÇ' : 'üïØÔ∏è';
            var typeText = event.type === 'birth' ? '–†–æ–¥–µ–Ω' : '–ü–æ—á–∏–Ω–∞–ª';
            var years = event.years_ago;
            var yearsText = years === 1 ? '–≥–æ–¥–∏–Ω–∞' : '–≥–æ–¥–∏–Ω–∏';
            
            html += '<a href="address.html?slug=' + encodeURIComponent(event.slug) + '" class="event-card">';
            html += '<div class="event-icon">' + icon + '</div>';
            html += '<div class="event-content">';
            html += '<div class="event-name">' + event.name + '</div>';
            html += '<div class="event-date">' + typeText + ' –Ω–∞ ' + event.full_date + '</div>';
            html += '<div class="event-years">–ü—Ä–µ–¥–∏ ' + years + ' ' + yearsText + '</div>';
            html += '</div></a>';
        });
        
        listEl.innerHTML = html;
        listEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    
    document.getElementById('prevMonth').addEventListener('click', function() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        selectedDate = null;
        document.getElementById('eventsList').innerHTML = '';
        saveCalendarState();
        loadEvents();
    });
    
    document.getElementById('nextMonth').addEventListener('click', function() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        selectedDate = null;
        document.getElementById('eventsList').innerHTML = '';
        saveCalendarState();
        loadEvents();
    });
    
    document.getElementById('todayBtn').addEventListener('click', function() {
        currentDate = new Date();
        selectedDate = null;
        document.getElementById('eventsList').innerHTML = '';
        saveCalendarState();
        loadEvents();
    });
    
    document.getElementById('year').textContent = new Date().getFullYear();
    loadEvents();
    loadAllPeople(); // Load search data
})();
</script>
</body>
</html>
