<!doctype html>
<html lang="en" data-theme="dark">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="icon" type="image/png" href="/assets/img/Historyaddress.bg2.png">
<link rel="shortcut icon" type="image/png" href="/assets/img/Historyaddress.bg2.png">
<link rel="apple-touch-icon" href="/assets/img/Historyaddress.bg2.png">
<meta name="msapplication-TileImage" content="/assets/img/Historyaddress.bg2.png">

	<title>–ê–¥—Ä–µ—Å—ä—Ç –Ω–∞ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞- –î–æ–º–æ–≤–µ</title>
	<meta name="description" content="Browse all historic addresses.">
	<script>
		(function() {
			try {
				var stored = localStorage.getItem('theme-preference');
				if (stored === 'system') stored = 'dark';
				var theme = (stored === 'dark' || stored === 'light') ? stored : 'dark';
				document.documentElement.setAttribute('data-theme', theme);
			} catch(e) {}
		})();
	</script>
	<link rel="stylesheet" href="assets/css/styles.css">
	<style>
		.pagination {
			display: flex;
			justify-content: center;
			align-items: center;
			gap: 0.5rem;
			margin: 2rem 0;
			flex-wrap: wrap;
		}
		
		.pagination button {
			padding: 0.5rem 1rem;
			border: 1px solid var(--border-color, #444);
			background: var(--bg-secondary, #2a2a2a);
			color: var(--text-color, #fff);
			cursor: pointer;
			border-radius: 4px;
			transition: all 0.2s;
		}
		
		.pagination button:hover:not(:disabled) {
			background: var(--primary-color, #007bff);
			border-color: var(--primary-color, #007bff);
		}
		
		.pagination button:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}
		
		.pagination button.active {
			background: var(--primary-color, #007bff);
			border-color: var(--primary-color, #007bff);
			font-weight: bold;
		}
		
		.pagination-info {
			color: var(--text-muted, #999);
			font-size: 0.9rem;
		}
		
		.loading {
			text-align: center;
			padding: 2rem;
			color: var(--text-muted, #999);
		}
		
		.error-message {
			text-align: center;
			padding: 2rem;
			color: #ff6b6b;
		}
	</style>
	<script src="assets/js/theme.js"></script>
	<script src="assets/js/transitions.js"></script>
</head>
<body>
	<header class="site-header">
		<a class="logo-link" href="index.html">
        <img src="assets/img/HistAdrLogo.png" alt="–ê–¥—Ä–µ—Å—ä—Ç –Ω–∞ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞" class="header-logo">
        <span class="logo-text">–ê–¥—Ä–µ—Å—ä—Ç –Ω–∞ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞</span>
    </a>
		<nav class="nav">
			<a href="index.html">–ù–∞—á–∞–ª–æ</a>
			<a href="map.html">–ö–∞—Ä—Ç–∞</a>
			<a href="addresses.html">–î–æ–º–æ–≤–µ</a>
			<a href="about.html">–ó–∞ –ù–∞—Å</a>
		</nav>
		<button id="theme-toggle" class="theme-toggle" aria-label="Toggle dark mode"></button>
	</header>

	<main class="container">
		<h1 class="page-title gradient-text">üè° –°–ø–∏—Å—ä–∫ –Ω–∞ –∞–¥—Ä–µ—Å–∏—Ç–µ</h1>
		<div class="toolbar">
			<input id="q" class="input" type="search" placeholder="–¢—ä—Ä—Å–µ–Ω–µ –ø–æ –∏–º–µ (–Ω–∞–ø—Ä. '–ò–≤–∞–Ω' –∏–ª–∏ '–ù–∏–∫–æ–ª–æ–≤')..." aria-label="Search">
			<select id="tag" class="select" aria-label="Filter by tag">
				<option value="">–í—Å–∏—á–∫–∏ —Ç–∞–≥–æ–≤–µ</option>
			</select>
		</div>
		
		<div class="pagination-info" id="pagination-info"></div>
		<div id="grid" class="grid" aria-live="polite"></div>
		<div class="pagination" id="pagination"></div>
	</main>

	<footer class="site-footer">
		<p>¬© <span id="year"></span> –ê–¥—Ä–µ—Å—ä—Ç –Ω–∞ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞</p>
	</footer>

	<script>
	(function() {
		var params = new URLSearchParams(location.search);
		var initialTag = params.get('tag') || '';
		var currentPage = 1;
		var totalPages = 1;
		var isLoading = false;
		var apiBase = window.location.protocol === 'file:' ? 'http://localhost:3000' : window.location.origin;
		var allHomes = []; 
		var filteredHomes = []; 
		
		function loadTags() {
			fetch(apiBase + '/api/tags')
				.then(function(res){ return res.json(); })
				.then(function(tags){
					var tagSel = document.getElementById('tag');
					tags.forEach(function(t){
						var o = document.createElement('option');
						o.value = t;
						o.textContent = t;
						tagSel.appendChild(o);
					});
					
					if (initialTag) {
						var match = Array.from(tagSel.options).find(function(o){ 
							return o.value.toLowerCase() === initialTag.toLowerCase(); 
						});
						if (match) {
							tagSel.value = match.value;
							console.log('Set tag filter to:', match.value);
						}
					}
				})
				.catch(function(err){
					console.error('Error loading tags:', err);
				});
		}
		

		function loadAllHomes() {
			if (isLoading) return;
			isLoading = true;
			
			var grid = document.getElementById('grid');
			grid.innerHTML = '<div class="loading">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</div>';
			

			var url = apiBase + '/api/homes?page=1&limit=1000';
			
			fetch(url)
				.then(function(res){ 
					if (!res.ok) {
						throw new Error('Network response was not ok: ' + res.statusText);
					}
					return res.json(); 
				})
				.then(function(response){
					isLoading = false;
					allHomes = response.data || response;
					console.log('‚úÖ Loaded', allHomes.length, 'homes from server');
					
					// Apply filters and render
					applyFiltersAndRender();
				})
				.catch(function(err){
					isLoading = false;
					console.error('Error loading homes:', err);
					grid.innerHTML = '<p class="error-message">–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –¥–æ–º–æ–≤–µ—Ç–µ –æ—Ç —Å—ä—Ä–≤—ä—Ä–∞.</p>';
				});
		}
		

		function applyFiltersAndRender() {
			var searchQuery = document.getElementById('q').value.trim();
			var tagFilter = document.getElementById('tag').value;
			

			var homes = allHomes.slice();
			

			if (searchQuery) {
				homes = filterHomesByWords(homes, searchQuery);
				console.log('üîç Search "' + searchQuery + '" found', homes.length, 'results');
			}
			

			if (tagFilter) {
				homes = homes.filter(function(home) {
					var tags = home.tags || [];
					return tags.some(function(tag) {
						return tag.toLowerCase() === tagFilter.toLowerCase();
					});
				});
				console.log('üè∑Ô∏è Tag "' + tagFilter + '" found', homes.length, 'results');
			}
			
			filteredHomes = homes;
			

			var itemsPerPage = 6;
			totalPages = Math.max(1, Math.ceil(filteredHomes.length / itemsPerPage));
			

			if (currentPage > totalPages) currentPage = totalPages;
			if (currentPage < 1) currentPage = 1;
			

			var startIdx = (currentPage - 1) * itemsPerPage;
			var endIdx = startIdx + itemsPerPage;
			var pageHomes = filteredHomes.slice(startIdx, endIdx);
			
			// Render
			renderHomes(pageHomes);
			renderPagination({
				page: currentPage,
				totalPages: totalPages,
				total: filteredHomes.length,
				limit: itemsPerPage,
				hasPrev: currentPage > 1,
				hasNext: currentPage < totalPages
			});
		}
		

		function filterHomesByWords(homes, query) {
			if (!query) return homes;
			

			var searchWords = query.toLowerCase().split(/\s+/).filter(Boolean);
			
			console.log('üîç Searching for words:', searchWords);
			
			return homes.filter(function(home) {
				var name = (home.name || '').toLowerCase();
				

				var matches = searchWords.every(function(word) {
					return name.indexOf(word) !== -1;
				});
				
				if (matches) {
					console.log('‚úì Match:', home.name);
				}
				
				return matches;
			});
		}
		
		function renderHomes(homes) {
			var grid = document.getElementById('grid');
			grid.innerHTML = '';
			
			if (homes.length === 0) {
				grid.innerHTML = '<p class="error-message">–ù—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏.</p>';
				return;
			}
			
			homes.forEach(function(p){
				var slugValue = p.slug;
				var idValue = p.id;

				var finalSlug = '';
				if (typeof slugValue === 'string' && slugValue) {
					finalSlug = slugValue;
				} else if (typeof slugValue === 'object' && slugValue !== null && slugValue.slug) {
					finalSlug = String(slugValue.slug);
				} else if (typeof idValue === 'string' && idValue) {
					finalSlug = idValue;
				} else if (typeof idValue === 'object' && idValue !== null && idValue.id) {
					finalSlug = String(idValue.id);
				}
				
				if (!finalSlug) {
					console.error('Skipping home - no valid slug:', p.name);
					return; 
				}

				var placeholder = 'assets/img/placeholder.svg';
				var img = placeholder;
				if (p.images && p.images[0]) {
					img = p.images[0].thumb || p.images[0].path || placeholder;
				}
				
				var el = document.createElement('a');
				el.className = 'thumb';
				el.href = 'address.html?slug=' + encodeURIComponent(finalSlug); 
				
				var imgAlt = (p.images && p.images[0] && p.images[0].alt) || ('Facade of ' + p.name);
				el.innerHTML = '<img alt="' + imgAlt + '" loading="lazy" src="' + img + '" onerror="this.onerror=null;this.src=\'' + placeholder + '\';">' +
					'<div class="meta"><strong>' + p.name + '</strong><div class="muted">' + (p.address || '') + '</div></div>';
				grid.appendChild(el);
			});
		}
		
		function renderPagination(pagination) {
			var paginationDiv = document.getElementById('pagination');
			var infoDiv = document.getElementById('pagination-info');
			
			paginationDiv.innerHTML = '';
			

			var start = Math.min((pagination.page - 1) * pagination.limit + 1, pagination.total);
			var end = Math.min(pagination.page * pagination.limit, pagination.total);
			infoDiv.textContent = '–ü–æ–∫–∞–∑–≤–∞–Ω–µ ' + start + '-' + end + ' –æ—Ç ' + pagination.total + ' –∞–¥—Ä–µ—Å–∞';
			
			if (pagination.totalPages <= 1) return;
			

			var prevBtn = document.createElement('button');
			prevBtn.textContent = '‚Üê –ü—Ä–µ–¥–∏—à–Ω–∞';
			prevBtn.disabled = !pagination.hasPrev;
			prevBtn.onclick = function() {
				if (pagination.hasPrev) {
					currentPage--;
					applyFiltersAndRender();
					window.scrollTo({ top: 0, behavior: 'smooth' });
				}
			};
			paginationDiv.appendChild(prevBtn);
			
			var startPage = Math.max(1, currentPage - 2);
			var endPage = Math.min(pagination.totalPages, currentPage + 2);
			

			if (startPage > 1) {
				var firstBtn = document.createElement('button');
				firstBtn.textContent = '1';
				firstBtn.onclick = function() {
					currentPage = 1;
					applyFiltersAndRender();
					window.scrollTo({ top: 0, behavior: 'smooth' });
				};
				paginationDiv.appendChild(firstBtn);
				
				if (startPage > 2) {
					var dots = document.createElement('span');
					dots.textContent = '...';
					dots.style.padding = '0.5rem';
					paginationDiv.appendChild(dots);
				}
			}
			

			for (var i = startPage; i <= endPage; i++) {
				var pageBtn = document.createElement('button');
				pageBtn.textContent = i;
				pageBtn.className = i === currentPage ? 'active' : '';
				pageBtn.dataset.page = i;
				pageBtn.onclick = function() {
					currentPage = parseInt(this.dataset.page);
					applyFiltersAndRender();
					window.scrollTo({ top: 0, behavior: 'smooth' });
				};
				paginationDiv.appendChild(pageBtn);
			}
			
			// Last page + dots
			if (endPage < pagination.totalPages) {
				if (endPage < pagination.totalPages - 1) {
					var dots2 = document.createElement('span');
					dots2.textContent = '...';
					dots2.style.padding = '0.5rem';
					paginationDiv.appendChild(dots2);
				}
				
				var lastBtn = document.createElement('button');
				lastBtn.textContent = pagination.totalPages;
				lastBtn.onclick = function() {
					currentPage = pagination.totalPages;
					applyFiltersAndRender();
					window.scrollTo({ top: 0, behavior: 'smooth' });
				};
				paginationDiv.appendChild(lastBtn);
			}
			

			var nextBtn = document.createElement('button');
			nextBtn.textContent = '–°–ª–µ–¥–≤–∞—â–∞ ‚Üí';
			nextBtn.disabled = !pagination.hasNext;
			nextBtn.onclick = function() {
				if (pagination.hasNext) {
					currentPage++;
					applyFiltersAndRender();
					window.scrollTo({ top: 0, behavior: 'smooth' });
				}
			};
			paginationDiv.appendChild(nextBtn);
		}
		
		var searchTimeout;
		

		document.getElementById('q').addEventListener('input', function() {
			clearTimeout(searchTimeout);
			searchTimeout = setTimeout(function() {
				currentPage = 1;
				applyFiltersAndRender();
			}, 500);
		});
		

		document.getElementById('q').addEventListener('keypress', function(e) {
			if (e.key === 'Enter') {
				clearTimeout(searchTimeout);
				currentPage = 1;
				applyFiltersAndRender();
			}
		});
		
		// Tag filter
		document.getElementById('tag').addEventListener('change', function() {
			currentPage = 1;
			applyFiltersAndRender();
		});
		
		document.getElementById('year').textContent = new Date().getFullYear();
		loadTags();
		loadAllHomes(); 
	})();
	</script>
</body>
</html>
