<!doctype html>
<html lang="en" data-theme="dark">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="icon" type="image/png" href="/assets/img/Historyaddress.bg2.png">
<link rel="shortcut icon" type="image/png" href="/assets/img/Historyaddress.bg2.png">
<link rel="apple-touch-icon" href="/assets/img/Historyaddress.bg2.png">
<meta name="msapplication-TileImage" content="/assets/img/Historyaddress.bg2.png">

	<title>–ê–¥—Ä–µ—Å—ä—Ç –Ω–∞ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞- –î–æ–º–æ–≤–µ</title>
	<meta name="description" content="Browse all historic addresses.">
	<script>
		(function() {
			try {
				var stored = localStorage.getItem('theme-preference');
				if (stored === 'system') stored = 'dark';
				var theme = (stored === 'dark' || stored === 'light') ? stored : 'dark';
				document.documentElement.setAttribute('data-theme', theme);
			} catch(e) {}
		})();
	</script>
	<link rel="stylesheet" href="assets/css/styles.css">
	<style>
		.pagination {
			display: flex;
			justify-content: center;
			align-items: center;
			gap: 12px;
			margin: 24px 0;
			flex-wrap: wrap;
		}
		.pagination button {
			min-width: 60px;
			padding: 0.5rem 1rem;
			border: 1px solid var(--border-color, #444);
			background: var(--bg-secondary, #2a2a2a);
			color: var(--text-color, #fff);
			cursor: pointer;
			border-radius: 4px;
		}
		.pagination button:hover:not(:disabled) {
			background: var(--primary-color, #007bff);
		}
		.pagination button:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}
		.page-info {
			padding: 8px 16px;
			color: var(--text-muted, #999);
		}
	</style>
	<script defer src="assets/js/theme.js"></script>
	<script defer src="assets/js/transitions.js"></script>
</head>
<body>
	<header class="site-header">
		<a class="logo-link" href="index.html">
        <img src="assets/img/HistAdrLogo.png" alt="–ê–¥—Ä–µ—Å—ä—Ç –Ω–∞ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞" class="header-logo">
        <span class="logo-text">–ê–¥—Ä–µ—Å—ä—Ç –Ω–∞ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞</span>
    </a>
		<nav class="nav">
			<a href="index.html">–ù–∞—á–∞–ª–æ</a>
			<a href="map.html">–ö–∞—Ä—Ç–∞</a>
			<a href="addresses.html">–î–æ–º–æ–≤–µ</a>
			<a href="about.html">–ó–∞ –ù–∞—Å</a>
		</nav>
		<button id="theme-toggle" class="theme-toggle" aria-label="Toggle dark mode"></button>
	</header>

	<main class="container">
		<h1 class="page-title gradient-text">üè° –°–ø–∏—Å—ä–∫ –Ω–∞ –∞–¥—Ä–µ—Å–∏—Ç–µ</h1>
		<div class="toolbar">
			<input id="q" class="input" type="search" placeholder="–¢—ä—Ä—Å–µ–Ω–µ –ø–æ –∏–º–µ (–Ω–∞–ø—Ä. '–ò–≤–∞–Ω' –∏–ª–∏ '–ì–µ–æ—Ä–≥–∏–µ–≤')..." aria-label="Search">
			<select id="tag" class="select" aria-label="Filter by tag">
				<option value="">–í—Å–∏—á–∫–∏ —Ç–∞–≥–æ–≤–µ</option>
			</select>
		</div>
		
		<div id="grid" class="grid" aria-live="polite"></div>
		
		<div class="pagination">
			<button id="firstPage" class="theme-toggle">First</button>
			<button id="prevPage" class="theme-toggle">Previous</button>
			<span class="page-info" id="pageInfo">Page 1 of 1</span>
			<button id="nextPage" class="theme-toggle">Next</button>
			<button id="lastPage" class="theme-toggle">Last</button>
		</div>
	</main>

	<footer class="site-footer">
		<p>¬© <span id="year"></span> –ê–¥—Ä–µ—Å—ä—Ç –Ω–∞ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞</p>
	</footer>

	<script>
	(function() {
		var params = new URLSearchParams(location.search);
		var initialTag = params.get('tag') || '';
		var state = {
			currentPage: 1,
			totalPages: 1,
			totalHomes: 0,
			currentHomes: [],
			searchQuery: ''
		};
		var isLoading = false;
		var apiBase = window.location.protocol === 'file:' ? 'http://localhost:3000' : window.location.origin;
		var searchTimeout;
		
		function loadTags() {
			fetch(apiBase + '/api/tags')
				.then(function(res){ return res.json(); })
				.then(function(tags){
					var tagSel = document.getElementById('tag');
					tags.forEach(function(t){
						var o = document.createElement('option');
						o.value = t;
						o.textContent = t;
						tagSel.appendChild(o);
					});
					
					if (initialTag) {
						var match = Array.from(tagSel.options).find(function(o){ 
							return o.value.toLowerCase() === initialTag.toLowerCase(); 
						});
						if (match) {
							tagSel.value = match.value;
						}
					}
				})
				.catch(function(err){
					console.error('Error loading tags:', err);
				});
		}
		
		function loadHomes(page) {
			if (isLoading) return;
			isLoading = true;
			
			page = page || state.currentPage;
			var url = apiBase + '/api/homes?page=' + page + '&limit=6';
			
			if (state.searchQuery) {
				url += '&search=' + encodeURIComponent(state.searchQuery);
				url += '&searchMode=name';
			}
			
			var tagFilter = document.getElementById('tag').value;
			if (tagFilter) url += '&tag=' + encodeURIComponent(tagFilter);
			
			var grid = document.getElementById('grid');
			grid.innerHTML = '<p style="text-align:center;padding:2rem;">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</p>';
			
			fetch(url)
				.then(function(res){ 
					if (!res.ok) throw new Error('Server error');
					return res.json(); 
				})
				.then(function(response){
					isLoading = false;
					
					var homes = response.data || response;
					var pagination = response.pagination || {
						page: 1,
						totalPages: 1,
						total: homes.length
					};
					
					state.currentHomes = homes;
					state.currentPage = pagination.page;
					state.totalPages = pagination.totalPages;
					state.totalHomes = pagination.total;
					
					renderHomes();
					updatePagination();
				})
				.catch(function(err){
					isLoading = false;
					console.error('Error loading homes:', err);
					grid.innerHTML = '<p style="text-align:center;padding:2rem;color:#ff6b6b;">–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ.</p>';
				});
		}
		
		function renderHomes() {
			var grid = document.getElementById('grid');
			grid.innerHTML = '';
			
			if (state.currentHomes.length === 0) {
				grid.innerHTML = '<p style="text-align:center;padding:2rem;color:#999;">–ù—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏.</p>';
				return;
			}
			
			state.currentHomes.forEach(function(p){
				var finalSlug = '';
				if (typeof p.slug === 'string' && p.slug) {
					finalSlug = p.slug;
				} else if (typeof p.id === 'string' && p.id) {
					finalSlug = p.id;
				}
				
				if (!finalSlug) return;

				var placeholder = 'assets/img/placeholder.svg';
				var img = placeholder;
				if (p.images && p.images[0]) {
					img = p.images[0].thumb || p.images[0].path || placeholder;
				}
				
				var el = document.createElement('a');
				el.className = 'thumb';
				el.href = 'address.html?slug=' + encodeURIComponent(finalSlug); 
				
				var imgAlt = (p.images && p.images[0] && p.images[0].alt) || ('Facade of ' + p.name);
				el.innerHTML = '<img alt="' + imgAlt + '" loading="lazy" src="' + img + '" onerror="this.onerror=null;this.src=\'' + placeholder + '\';">' +
					'<div class="meta"><strong>' + p.name + '</strong><div class="muted">' + (p.address || '') + '</div></div>';
				grid.appendChild(el);
			});
		}
		
		function updatePagination() {
			var info = 'Page ' + state.currentPage + ' of ' + state.totalPages;
			if (state.totalHomes > 0) {
				info += ' (' + state.totalHomes + ' total)';
			}
			document.getElementById('pageInfo').textContent = info;
			document.getElementById('firstPage').disabled = state.currentPage === 1;
			document.getElementById('prevPage').disabled = state.currentPage === 1;
			document.getElementById('nextPage').disabled = state.currentPage >= state.totalPages;
			document.getElementById('lastPage').disabled = state.currentPage >= state.totalPages;
		}
		
		function goToPage(page) {
			if (page < 1) page = 1;
			if (page > state.totalPages) page = state.totalPages;
			state.currentPage = page;
			loadHomes(page);
			window.scrollTo({ top: 0, behavior: 'smooth' });
		}
		
		document.getElementById('firstPage').addEventListener('click', function(){ goToPage(1); });
		document.getElementById('prevPage').addEventListener('click', function(){ goToPage(state.currentPage - 1); });
		document.getElementById('nextPage').addEventListener('click', function(){ goToPage(state.currentPage + 1); });
		document.getElementById('lastPage').addEventListener('click', function(){ goToPage(state.totalPages); });
		
		document.getElementById('q').addEventListener('input', function() {
			clearTimeout(searchTimeout);
			searchTimeout = setTimeout(function() {
				state.searchQuery = document.getElementById('q').value.trim();
				state.currentPage = 1;
				loadHomes(1);
			}, 500);
		});
		
		document.getElementById('q').addEventListener('keypress', function(e) {
			if (e.key === 'Enter') {
				clearTimeout(searchTimeout);
				state.searchQuery = document.getElementById('q').value.trim();
				state.currentPage = 1;
				loadHomes(1);
			}
		});
		
		document.getElementById('tag').addEventListener('change', function() {
			state.currentPage = 1;
			loadHomes(1);
		});
		
		document.getElementById('year').textContent = new Date().getFullYear();
		loadTags();
		loadHomes(1);
	})();
	</script>
</body>
</html>
