<!doctype html>
<html lang="en" data-theme="dark">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>–ê–¥—Ä–µ—Å—ä—Ç –Ω–∞ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞- –î–æ–º–æ–≤–µ</title>
	<meta name="description" content="Browse all historic addresses.">
	<link rel="icon" href="/assets/img/HistAdrLogoOrig.ico">
	<script>
		// Apply theme immediately to prevent flash
		(function() {
			try {
				var stored = localStorage.getItem('theme-preference');
				if (stored === 'system') stored = 'dark';
				var theme = (stored === 'dark' || stored === 'light') ? stored : 'dark';
				document.documentElement.setAttribute('data-theme', theme);
			} catch(e) {}
		})();
	</script>
	<link rel="stylesheet" href="assets/css/styles.css">
	<style>
		/* Pagination styles */
		.pagination {
			display: flex;
			justify-content: center;
			align-items: center;
			gap: 0.5rem;
			margin: 2rem 0;
			flex-wrap: wrap;
		}
		
		.pagination button {
			padding: 0.5rem 1rem;
			border: 1px solid var(--border-color, #444);
			background: var(--bg-secondary, #2a2a2a);
			color: var(--text-color, #fff);
			cursor: pointer;
			border-radius: 4px;
			transition: all 0.2s;
		}
		
		.pagination button:hover:not(:disabled) {
			background: var(--primary-color, #007bff);
			border-color: var(--primary-color, #007bff);
		}
		
		.pagination button:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}
		
		.pagination button.active {
			background: var(--primary-color, #007bff);
			border-color: var(--primary-color, #007bff);
			font-weight: bold;
		}
		
		.pagination-info {
			color: var(--text-muted, #999);
			font-size: 0.9rem;
		}
		
		.loading {
			text-align: center;
			padding: 2rem;
			color: var(--text-muted, #999);
		}
		
		.error-message {
			text-align: center;
			padding: 2rem;
			color: #ff6b6b;
		}
	</style>
	<script src="assets/js/theme.js"></script>
	<script src="assets/js/transitions.js"></script>
</head>
<body>
	<header class="site-header">
		<a class="logo-link" href="index.html">
        <img src="assets/img/HistAdrLogo.png" alt="–ê–¥—Ä–µ—Å—ä—Ç –Ω–∞ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞" class="header-logo">
        <span class="logo-text">–ê–¥—Ä–µ—Å—ä—Ç –Ω–∞ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞</span>
    </a>
		<nav class="nav">
			<a href="index.html">–ù–∞—á–∞–ª–æ</a>
			<a href="map.html">–ö–∞—Ä—Ç–∞</a>
			<a href="addresses.html">–î–æ–º–æ–≤–µ</a>
			<a href="about.html">–ó–∞ –ù–∞—Å</a>
		</nav>
		<button id="theme-toggle" class="theme-toggle" aria-label="Toggle dark mode"></button>
	</header>

	<main class="container">
		<h1 class="page-title gradient-text">üè° –°–ø–∏—Å—ä–∫ –Ω–∞ –∞–¥—Ä–µ—Å–∏—Ç–µ</h1>
		<div class="toolbar">
			<input id="q" class="input" type="search" placeholder="–¢—ä—Ä—Å–µ–Ω–µ –ø–æ –∏–º–µ..." aria-label="Search">
			<select id="tag" class="select" aria-label="Filter by tag">
				<option value="">–í—Å–∏—á–∫–∏ —Ç–∞–≥–æ–≤–µ</option>
			</select>
		</div>
		
		<div class="pagination-info" id="pagination-info"></div>
		<div id="grid" class="grid" aria-live="polite"></div>
		<div class="pagination" id="pagination"></div>
	</main>

	<footer class="site-footer">
		<p>¬© <span id="year"></span> –ê–¥—Ä–µ—Å—ä—Ç –Ω–∞ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞</p>
	</footer>

	<script>
	(function() {
		var params = new URLSearchParams(location.search);
		var initialTag = params.get('tag') || '';
		var currentPage = 1;
		var totalPages = 1;
		var isLoading = false;
		var apiBase = window.location.protocol === 'file:' ? 'http://localhost:3000' : window.location.origin;
		
		// Fetch tags for dropdown
		function loadTags() {
			fetch(apiBase + '/api/tags')
				.then(function(res){ return res.json(); })
				.then(function(tags){
					var tagSel = document.getElementById('tag');
					tags.forEach(function(t){
						var o = document.createElement('option');
						o.value = t;
						o.textContent = t;
						tagSel.appendChild(o);
					});
					
					// Set initial tag from URL parameter (case-insensitive match)
					if (initialTag) {
						var match = Array.from(tagSel.options).find(function(o){ 
							return o.value.toLowerCase() === initialTag.toLowerCase(); 
						});
						if (match) {
							tagSel.value = match.value;
							console.log('Set tag filter to:', match.value);
						}
					}
				})
				.catch(function(err){
					console.error('Error loading tags:', err);
				});
		}
		
		// Fetch homes with pagination
		function loadHomes(page) {
			if (isLoading) return;
			isLoading = true;
			
			var searchQuery = document.getElementById('q').value;
			var tagFilter = document.getElementById('tag').value;
			
			var url = apiBase + '/api/homes?page=' + page + '&limit=6';
			if (searchQuery) {
				url += '&search=' + encodeURIComponent(searchQuery);
				url += '&searchMode=name'; // Always search by name only
			}
			if (tagFilter) url += '&tag=' + encodeURIComponent(tagFilter);
			
			var grid = document.getElementById('grid');
			grid.innerHTML = '<div class="loading">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</div>';
			
			fetch(url)
				.then(function(res){ 
					if (!res.ok) {
						throw new Error('Network response was not ok: ' + res.statusText);
					}
					return res.json(); 
				})
				.then(function(response){
					isLoading = false;
					
					// Handle both old format (array) and new format (object with data/pagination)
					var homes = response.data || response;
					var pagination = response.pagination || {
						page: 1,
						totalPages: 1,
						total: homes.length
					};
					
					currentPage = pagination.page;
					totalPages = pagination.totalPages;
					
					renderHomes(homes);
					renderPagination(pagination);
					updatePaginationInfo(pagination);
				})
				.catch(function(err){
					isLoading = false;
					console.error('Error loading homes:', err);
					grid.innerHTML = '<p class="error-message">–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –¥–æ–º–æ–≤–µ—Ç–µ –æ—Ç —Å—ä—Ä–≤—ä—Ä–∞. –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ –∫–æ–Ω–∑–æ–ª–∞—Ç–∞ –∑–∞ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏.</p>';
				});
		}
		
		// Render homes grid
		function renderHomes(homes) {
			var grid = document.getElementById('grid');
			grid.innerHTML = '';
			
			if (homes.length === 0) {
				grid.innerHTML = '<p class="error-message">–ù—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏.</p>';
				return;
			}
			
			homes.forEach(function(p){
				var slugValue = p.slug;
				var idValue = p.id;

				if (typeof slugValue !== 'string' && typeof slugValue === 'object' && slugValue !== null) {
					console.warn('Home Name:', p.name, ' - WARNING: p.slug is an object!', slugValue);
				}
				if (typeof idValue !== 'string' && typeof idValue === 'object' && idValue !== null) {
					console.warn('Home Name:', p.name, ' - WARNING: p.id is an object!', idValue);
				}

				var finalSlug = '';
				if (typeof slugValue === 'string' && slugValue) {
					finalSlug = slugValue;
				} else if (typeof slugValue === 'object' && slugValue !== null && slugValue.slug) {
					finalSlug = String(slugValue.slug);
				} else if (typeof idValue === 'string' && idValue) {
					finalSlug = idValue;
				} else if (typeof idValue === 'object' && idValue !== null && idValue.id) {
					finalSlug = String(idValue.id);
				}
				
				if (!finalSlug) {
					console.error('Skipping home because neither slug nor id is a valid string/property:', p.name, p);
					return; 
				}

				var placeholder = 'assets/img/placeholder.svg';
				
				// Use thumbnail if available, otherwise use full image
				var img = placeholder;
				if (p.images && p.images[0]) {
					img = p.images[0].thumb || p.images[0].path || placeholder;
				}
				
				var el = document.createElement('a');
				el.className = 'thumb';
				el.href = 'address.html?slug=' + encodeURIComponent(finalSlug); 
				
				var imgAlt = (p.images && p.images[0] && p.images[0].alt) || ('Facade of ' + p.name);
				el.innerHTML = '<img alt="' + imgAlt + '" loading="lazy" src="' + img + '" onerror="this.onerror=null;this.src=\'' + placeholder + '\';">' +
					'<div class="meta"><strong>' + p.name + '</strong><div class="muted">' + (p.address || '') + '</div></div>';
				grid.appendChild(el);
			});
		}
		
		// Render pagination controls
		function renderPagination(pagination) {
			var paginationDiv = document.getElementById('pagination');
			paginationDiv.innerHTML = '';
			
			if (pagination.totalPages <= 1) return;
			
			// Previous button
			var prevBtn = document.createElement('button');
			prevBtn.textContent = '‚Üê –ü—Ä–µ–¥–∏—à–Ω–∞';
			prevBtn.disabled = !pagination.hasPrev;
			prevBtn.onclick = function() {
				if (pagination.hasPrev) {
					loadHomes(currentPage - 1);
					window.scrollTo({ top: 0, behavior: 'smooth' });
				}
			};
			paginationDiv.appendChild(prevBtn);
			
			// Page numbers
			var startPage = Math.max(1, currentPage - 2);
			var endPage = Math.min(pagination.totalPages, currentPage + 2);
			
			if (startPage > 1) {
				var firstBtn = document.createElement('button');
				firstBtn.textContent = '1';
				firstBtn.onclick = function() {
					loadHomes(1);
					window.scrollTo({ top: 0, behavior: 'smooth' });
				};
				paginationDiv.appendChild(firstBtn);
				
				if (startPage > 2) {
					var dots = document.createElement('span');
					dots.textContent = '...';
					dots.style.padding = '0.5rem';
					paginationDiv.appendChild(dots);
				}
			}
			
			for (var i = startPage; i <= endPage; i++) {
				var pageBtn = document.createElement('button');
				pageBtn.textContent = i;
				pageBtn.className = i === currentPage ? 'active' : '';
				pageBtn.dataset.page = i;
				pageBtn.onclick = function() {
					var page = parseInt(this.dataset.page);
					loadHomes(page);
					window.scrollTo({ top: 0, behavior: 'smooth' });
				};
				paginationDiv.appendChild(pageBtn);
			}
			
			if (endPage < pagination.totalPages) {
				if (endPage < pagination.totalPages - 1) {
					var dots2 = document.createElement('span');
					dots2.textContent = '...';
					dots2.style.padding = '0.5rem';
					paginationDiv.appendChild(dots2);
				}
				
				var lastBtn = document.createElement('button');
				lastBtn.textContent = pagination.totalPages;
				lastBtn.onclick = function() {
					loadHomes(pagination.totalPages);
					window.scrollTo({ top: 0, behavior: 'smooth' });
				};
				paginationDiv.appendChild(lastBtn);
			}
			
			// Next button
			var nextBtn = document.createElement('button');
			nextBtn.textContent = '–°–ª–µ–¥–≤–∞—â–∞ ‚Üí';
			nextBtn.disabled = !pagination.hasNext;
			nextBtn.onclick = function() {
				if (pagination.hasNext) {
					loadHomes(currentPage + 1);
					window.scrollTo({ top: 0, behavior: 'smooth' });
				}
			};
			paginationDiv.appendChild(nextBtn);
		}
		
		// Update pagination info text
		function updatePaginationInfo(pagination) {
			var info = document.getElementById('pagination-info');
			var start = (pagination.page - 1) * pagination.limit + 1;
			var end = Math.min(pagination.page * pagination.limit, pagination.total);
			info.textContent = '–ü–æ–∫–∞–∑–≤–∞–Ω–µ ' + start + '-' + end + ' –æ—Ç ' + pagination.total + ' –∞–¥—Ä–µ—Å–∞';
		}
		
		// Debounce function for search
		var searchTimeout;
		function debounce(func, delay) {
			return function() {
				clearTimeout(searchTimeout);
				searchTimeout = setTimeout(func, delay);
			};
		}
		
		// Event listeners
		document.getElementById('q').addEventListener('input', debounce(function() {
			currentPage = 1;
			loadHomes(1);
		}, 500));
		
		document.getElementById('tag').addEventListener('change', function() {
			currentPage = 1;
			loadHomes(1);
		});
		
		// Initialize
		document.getElementById('year').textContent = new Date().getFullYear();
		loadTags();
		loadHomes(1);
	})();
	</script>
</body>
</html>
