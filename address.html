<!doctype html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Адресът на историята</title>
<link rel="icon" href="/assets/img/HistAdrLogo.png">
    <script>
        // Apply theme immediately to prevent flash
        (function() {
            try {
                var stored = localStorage.getItem('theme-preference');
                if (stored === 'system') stored = 'dark';
                var theme = (stored === 'dark' || stored === 'light') ? stored : 'dark';
                document.documentElement.setAttribute('data-theme', theme);
            } catch(e) {}
        })();
    </script>
    <link rel="stylesheet" href="assets/css/styles.css">
    <script defer src="assets/js/theme.js"></script>
    <script defer src="assets/js/transitions.js"></script>
</head>
<body>
  <header class="site-header">
    <a class="logo-link" href="index.html">
        <img src="assets/img/HistAdrLogo.png" alt="Адресът на историята" class="header-logo">
        <span class="logo-text">Адресът на историята</span>
    </a>
		<nav class="nav">
			<a href="index.html">Начало</a>
			<a href="map.html">Карта</a>
			<a href="addresses.html">Домове</a>
			<a href="about.html">За Нас</a>
    </nav>
    <button id="theme-toggle" class="theme-toggle" aria-label="Toggle dark mode"></button>
</header>

    <main class="container">
        <div id="detail" class="detail">
            <p>Loading...</p>
        </div>
    </main>

    <footer class="site-footer">
        <p>© <span id="year"></span> Адресът на историята</p>
    </footer>

    <script>
    (function() {
        // Simple query parameter getter
        function q(name) {
            var url = window.location.href;
            name = name.replace(/[\[\]]/g, '\\$&');
            var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }

        var slug = q('slug');
        var root = document.getElementById('detail');
        
        if (!slug) {
            root.innerHTML = '<p>No home specified.</p>';
            return;
        }
        
        // Determine API base URL
        var apiBase = window.location.protocol === 'file:' ? 'http://localhost:3000' : window.location.origin;
        var API_URL = apiBase + '/api/homes/' + encodeURIComponent(slug);
        
        // Fetch home from API
        fetch(API_URL)
            .then(function(res){
                if (!res.ok) {
                    if (res.status === 404) throw new Error('Home not found');
                    throw new Error('Server error');
                }
                return res.json();
            })
            .then(function(person){
                renderHome(person);
            })
            .catch(function(err){
                console.error('Error loading home:', err);
                root.innerHTML = '<p>Error: ' + err.message + '. Please check the URL or server status.</p>';
            });
        
        function renderHome(person) {
            document.title = person.name + ' — Historic Addresses';
            var ph = 'assets/img/placeholder.svg';
            
            // --- НОВА HTML СТРУКТУРА ЗА ПОРТРЕТ И БИОГРАФИЯ ---
            var portraitHtml = '';
            if (person.portrait_url) {
                // Използваме 'portrait-image' за стилизиране
                portraitHtml = '<div class="portrait-container slide-in-left"><img class="portrait-image" alt="Portrait of ' + person.name + '" src="' + person.portrait_url + '" loading="lazy"></div>';
            }
            // ----------------------------
            
            var gallery = (person.images||[]);
            var hero = gallery[0] || null;
            
            // Основна снимка (Първата от галерията)
            var imgHtml = hero ? 
                '<img alt="'+((hero && hero.alt) || ('Facade of '+person.name))+'" loading="lazy" src="'+((hero && hero.path) || ph)+'" onerror="this.onerror=null;this.src=\''+ph+'\';">' :
                '';

            // Останалата галерия (снимки от 2-ра нататък)
            var galleryHtml = '';
            if ((gallery||[]).length > 1) {
                galleryHtml = '<div class="gallery slide-up">' + gallery.slice(1).map(function(i){ 
                    var s = (i && i.path) || ph; 
                    var a = (i && i.alt) || ('Facade of '+person.name); 
                    return '<img alt="'+a+'" loading="lazy" src="'+s+'" onerror="this.onerror=null;this.src=\''+ph+'\';">'; 
                }).join('') + '</div>';
            }
            
            var tags = (person.tags||[]).map(function(t){ return '<a class="tag" href="addresses.html?tag='+encodeURIComponent(t)+'">'+t+'</a>'; }).join(' ');
            var mapLink = (person.coordinates && person.coordinates.lat && person.coordinates.lng) ? ('map.html?slug=' + encodeURIComponent(person.slug||person.id)) : '';
            
            var sources = (person.sources||[]).map(function(s){
                var isUrl = /^https?:\/\//i.test(s.trim());
                return isUrl ? '<li><a href="'+s.trim()+'" rel="noopener" target="_blank">'+s.trim()+'</a></li>' : '<li>'+s.trim()+'</li>';
            }).join('');
            
            root.innerHTML =
                (imgHtml ? ('<p class="fade-in">'+imgHtml+'</p>') : '') +
                galleryHtml +
                '<h1 class="gradient-text slide-up">'+person.name+'</h1>'+
                '<p class="meta slide-up">Address: '+(person.address||'')+(mapLink ? ' — <a href="'+mapLink+'">View on map</a>' : '')+'</p>'+
                
                // ГРУПИРАНЕ НА ПОРТРЕТ И БИОГРАФИЯ (с новия клас)
                '<div class="content-split">'+
                    portraitHtml +
                    '<div class="biography-text slide-up">'+
                        '<p>'+ (person.biography||'') +'</p>'+
                    '</div>'+
                '</div>'+
                
                (person.photo_date ? ('<p class="meta slide-up">Photo date: '+person.photo_date+'</p>') : '')+
                (sources ? ('<h3 class="slide-up">Sources</h3><ul class="slide-up">'+sources+'</ul>') : '')+
                (tags ? ('<p class="tags slide-up">'+tags+'</p>') : '');
            
            document.getElementById('year').textContent = new Date().getFullYear();
        }
    })();
    </script>
	<div id="lightbox" class="lightbox-backdrop" style="display:none;">
        <div class="lightbox-content">
            <button id="closeLightbox" class="theme-toggle" aria-label="Close" title="Close">×</button>
            <img id="lightboxImage" src="" alt="Enlarged image" style="max-width: 90vw; max-height: 90vh;">
        </div>
    </div>

    <script>
    (function() {
        // ... (съществуващите функции q, renderHome и fetch logic) ...

        function renderHome(person) {
            // ... (съществуващият код за renderHome) ...

            // В КРАЯ НА ФУНКЦИЯТА renderHome, добавете слушатели за събития:
            
            // -------------------------------------------------------------
            // НОВА ЛОГИКА ЗА LIGHTBOX (Уголемяване на снимки)
            // -------------------------------------------------------------
            var lightbox = document.getElementById('lightbox');
            var lightboxImage = document.getElementById('lightboxImage');
            var closeLightbox = document.getElementById('closeLightbox');
            var detailContainer = document.getElementById('detail');

            function openLightbox(src) {
                lightboxImage.src = src;
                lightbox.style.display = 'flex';
                // За да предотвратим превъртане на основната страница
                document.body.style.overflow = 'hidden'; 
            }

            function closeLightboxModal() {
                lightbox.style.display = 'none';
                document.body.style.overflow = '';
            }

            // Слушател за клик върху снимка (Главна или от Галерията)
            detailContainer.addEventListener('click', function(e) {
                var target = e.target;
                // Проверява дали кликнатият елемент е img вътре в .detail
                if (target.tagName === 'IMG' && target.closest('.detail')) {
                    var imgSrc = target.getAttribute('src');
                    if (imgSrc && imgSrc.indexOf(ph) === -1) { // Избягваме placeholder-а
                        openLightbox(imgSrc);
                    }
                }
            });

            // Слушател за затваряне на lightbox
            closeLightbox.addEventListener('click', closeLightboxModal);
            
            // Слушател за затваряне при клик върху затъмнения фон
            lightbox.addEventListener('click', function(e) {
                if (e.target.id === 'lightbox') {
                    closeLightboxModal();
                }
            });

            // Слушател за затваряне при натискане на ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && lightbox.style.display === 'flex') {
                    closeLightboxModal();
                }
            });

            // -------------------------------------------------------------

            document.getElementById('year').textContent = new Date().getFullYear();
        }
    })();
	
    </script>
	<div id="lightbox" class="lightbox-backdrop" style="display:none;">
        <div class="lightbox-content">
            <button id="closeLightbox" class="close-btn" aria-label="Close" title="Close">×</button>
            <img id="lightboxImage" src="" alt="Enlarged image" style="max-width: 90vw; max-height: 90vh;">
        </div>
    </div>

    <script>
    (function() {
        // Simple query parameter getter
        function q(name) {
            var url = window.location.href;
            name = name.replace(/[\[\]]/g, '\\$&');
            var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }

        var slug = q('slug');
        var root = document.getElementById('detail');
        var ph = 'assets/img/placeholder.svg'; // Дефинираме го тук, за да е достъпен

        if (!slug) {
            root.innerHTML = '<p>No home specified.</p>';
            return;
        }
        
        // Fetch home from API
        var apiBase = window.location.protocol === 'file:' ? 'http://localhost:3000' : window.location.origin;
        var API_URL = apiBase + '/api/homes/' + encodeURIComponent(slug);
        
        fetch(API_URL)
            .then(function(res){
                if (!res.ok) {
                    if (res.status === 404) throw new Error('Home not found');
                    throw new Error('Server error');
                }
                return res.json();
            })
            .then(function(person){
                renderHome(person);
            })
            .catch(function(err){
                console.error('Error loading home:', err);
                root.innerHTML = '<p>Error: ' + err.message + '. Please check the URL or server status.</p>';
            });
        
        // --- ФУНКЦИЯ ЗА ГЕНЕРИРАНЕ НА HTML СЪДЪРЖАНИЕ ---
        function renderHome(person) {
            document.title = person.name + ' — Historic Addresses';
            
            // --- ГЕНЕРИРАНЕ НА HTML (Без промяна в тази част) ---
            var portraitHtml = '';
            if (person.portrait_url) {
                portraitHtml = '<div class="portrait-container slide-in-left"><img class="portrait-image" alt="Portrait of ' + person.name + '" src="' + person.portrait_url + '" loading="lazy"></div>';
            }
            
            var gallery = (person.images||[]);
            var hero = gallery[0] || null;
            
            // Основна снимка - ДОБАВЕН КЛАС "zoomable-image"
            var imgHtml = hero ? 
                '<img class="zoomable-image" alt="'+((hero && hero.alt) || ('Facade of '+person.name))+'" loading="lazy" src="'+((hero && hero.path) || ph)+'" onerror="this.onerror=null;this.src=\''+ph+'\';">' :
                '';

            // Останалата галерия - ДОБАВЕН КЛАС "zoomable-image"
            var galleryHtml = '';
            if ((gallery||[]).length > 1) {
                galleryHtml = '<div class="gallery slide-up">' + gallery.slice(1).map(function(i){ 
                    var s = (i && i.path) || ph; 
                    var a = (i && i.alt) || ('Facade of '+person.name); 
                    return '<img class="zoomable-image" alt="'+a+'" loading="lazy" src="'+s+'" onerror="this.onerror=null;this.src=\''+ph+'\';">'; 
                }).join('') + '</div>';
            }
            
            var tags = (person.tags||[]).map(function(t){ return '<a class="tag" href="addresses.html?tag='+encodeURIComponent(t)+'">'+t+'</a>'; }).join(' ');
            var mapLink = (person.coordinates && person.coordinates.lat && person.coordinates.lng) ? ('map.html?slug=' + encodeURIComponent(person.slug||person.id)) : '';
            
            var sources = (person.sources||[]).map(function(s){
                var isUrl = /^https?:\/\//i.test(s.trim());
                return isUrl ? '<li><a href="'+s.trim()+'" rel="noopener" target="_blank">'+s.trim()+'</a></li>' : '<li>'+s.trim()+'</li>';
            }).join('');
            
            root.innerHTML =
                (imgHtml ? ('<p class="fade-in">'+imgHtml+'</p>') : '') +
                galleryHtml +
                '<h1 class="gradient-text slide-up">'+person.name+'</h1>'+
                '<p class="meta slide-up">Address: '+(person.address||'')+(mapLink ? ' — <a href="'+mapLink+'">View on map</a>' : '')+'</p>'+
                
                '<div class="content-split">'+
                    portraitHtml +
                    '<div class="biography-text slide-up">'+
                        '<p>'+ (person.biography||'') +'</p>'+
                    '</div>'+
                '</div>'+
                
                (person.photo_date ? ('<p class="meta slide-up">Photo date: '+person.photo_date+'</p>') : '')+
                (sources ? ('<h3 class="slide-up">Sources</h3><ul class="slide-up">'+sources+'</ul>') : '')+
                (tags ? ('<p class="tags slide-up">'+tags+'</p>') : '');
            
            document.getElementById('year').textContent = new Date().getFullYear();
        }
        
        
        // --- НОВА ИЗВЪН-ФУНКЦИОНАЛНА ЛОГИКА ЗА LIGHTBOX ---
        
        var lightbox = document.getElementById('lightbox');
        var lightboxImage = document.getElementById('lightboxImage');
        var closeLightbox = document.getElementById('closeLightbox');
        var detailContainer = document.getElementById('detail');

        function openLightbox(src) {
            lightboxImage.src = src;
            lightbox.style.display = 'flex';
            document.body.style.overflow = 'hidden'; 
        }

        function closeLightboxModal() {
            lightbox.style.display = 'none';
            document.body.style.overflow = '';
        }

        // 1. Слушател за клик върху снимка (Използваме делегиране на събития върху контейнера #detail)
        detailContainer.addEventListener('click', function(e) {
            var target = e.target;
            // Търси елементи с новия клас "zoomable-image"
            if (target.classList.contains('zoomable-image')) {
                var imgSrc = target.getAttribute('src');
                if (imgSrc && imgSrc.indexOf(ph) === -1) { // Проверява дали не е placeholder
                    openLightbox(imgSrc);
                }
            }
        });

        // 2. Слушател за затваряне на lightbox чрез бутон
        closeLightbox.addEventListener('click', closeLightboxModal);
        
        // 3. Слушател за затваряне при клик върху затъмнения фон
        lightbox.addEventListener('click', function(e) {
            // Затваря само ако се кликне върху самия фон (#lightbox), а не върху снимката
            if (e.target.id === 'lightbox') {
                closeLightboxModal();
            }
        });

        // 4. Слушател за затваряне при натискане на ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && lightbox.style.display === 'flex') {
                closeLightboxModal();
            }
        });

    })();
    </script>
</body>
</html>
</body>
</html>
</body>
</html>
