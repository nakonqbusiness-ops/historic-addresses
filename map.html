<!doctype html>
<html lang="en" data-theme="dark">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="icon" type="image/png" href="/assets/img/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="/assets/img/favicon.svg" />
<link rel="shortcut icon" href="/assets/img/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/apple-touch-icon.png" />
<link rel="manifest" href="/assets/img/site.webmanifest" />

<meta name="msapplication-TileImage" content="/assets/img/Historyaddress.bg2.png">

	<title>–ê–¥—Ä–µ—Å—ä—Ç –Ω–∞ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞ - –ö–∞—Ä—Ç–∞</title>
	<meta name="description" content="Map of historic addresses.">
	<link rel="icon" href="/assets/img/HistAdrLogoOrig.ico">
	<script>
		(function() {
			try {
				var stored = localStorage.getItem('theme-preference');
				if (stored === 'system') stored = 'dark';
				var theme = (stored === 'dark' || stored === 'light') ? stored : 'dark';
				document.documentElement.setAttribute('data-theme', theme);
			} catch(e) {}
		})();
	</script>
	<link rel="stylesheet" href="assets/css/styles.css">
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
	<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
	<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
	<script defer src="assets/js/theme.js"></script>
	<script defer src="assets/js/transitions.js"></script>
	<script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
	<script defer src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
	<style>
		.marker-cluster-small, .marker-cluster-medium, .marker-cluster-large {
			background-color: rgba(0, 123, 255, 0.6);
		}
		.marker-cluster-small div, .marker-cluster-medium div, .marker-cluster-large div {
			background-color: rgba(0, 123, 255, 0.8);
			color: white;
			font-weight: bold;
		}
		.map-loading {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			background: rgba(0, 0, 0, 0.85);
			color: white;
			padding: 1.5rem 2.5rem;
			border-radius: 8px;
			z-index: 1000;
			font-size: 1.1rem;
			box-shadow: 0 4px 12px rgba(0,0,0,0.5);
		}
		.map-loading::after {
			content: '';
			display: inline-block;
			width: 16px;
			height: 16px;
			margin-left: 10px;
			border: 3px solid rgba(255,255,255,0.3);
			border-top-color: white;
			border-radius: 50%;
			animation: spin 0.8s linear infinite;
		}
		@keyframes spin {
			to { transform: rotate(360deg); }
		}

		.logo-pin {
			width: 40px;
			height: 40px;
			background-image: url('assets/img/Historyaddress.bg.jpg');
			background-size: contain;
			background-position: center;
			background-repeat: no-repeat;
			border-radius: 50%;
			border: 2px solid white;
			box-shadow: 0 2px 8px rgba(0,0,0,0.3);
			cursor: pointer;
		}
		.logo-pin:hover {
			transform: scale(1.1);
			box-shadow: 0 4px 12px rgba(0,0,0,0.5);
		}
	</style>
	<!-- Add this in the <head> section, after the other script tags -->
<script defer src="assets/js/calendar-popup.js"></script>
<link rel="canonical" href="https://historyaddress.bg/map.html">
<meta name="robots" content="index, follow">
</head>
<script>
function handleEmailClick(event) {
    // On mobile (screen width < 768px), let mailto work normally
    if (window.innerWidth <= 768) {
        return; // Don't prevent default, let mailto: work
    }
    
    // On desktop, show modal
    event.preventDefault();
    showEmailModal();
}

function showEmailModal() {
    var modal = document.getElementById('emailModal');
    if (!modal) {
        // Create modal if it doesn't exist
        modal = document.createElement('div');
        modal.id = 'emailModal';
        modal.className = 'email-modal';
        modal.innerHTML = `
            <div class="email-modal-content">
                <h3>üìß –°–≤—ä—Ä–∂–µ—Ç–µ —Å–µ —Å –Ω–∞—Å</h3>
                <div class="email-address-display" id="emailDisplay">historyaddressbg@gmail.com</div>
                <div class="email-modal-buttons">
                    <button class="btn-copy" onclick="copyEmail()">
                        <span id="copyText">üìã –ö–æ–ø–∏—Ä–∞–π Email</span>
                    </button>
                    <button class="btn-close" onclick="closeEmailModal()">‚úï –ó–∞—Ç–≤–æ—Ä–∏</button>
                </div>
                <p>–ú–æ–∂–µ—Ç–µ –¥–∞ –Ω–∏ –ø–∏—à–µ—Ç–µ –∑–∞ –≤—ä–ø—Ä–æ—Å–∏ –∏–ª–∏ –ø–æ–¥–∫—Ä–µ–ø–∞</p>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Close on backdrop click
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeEmailModal();
            }
        });
    }
    
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeEmailModal() {
    var modal = document.getElementById('emailModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = '';
    }
}

function copyEmail() {
    var email = 'historyaddressbg@gmail.com';
    navigator.clipboard.writeText(email).then(function() {
        var btn = document.querySelector('.btn-copy');
        var text = document.getElementById('copyText');
        
        btn.classList.add('copied');
        text.textContent = '‚úì –ö–æ–ø–∏—Ä–∞–Ω–æ!';
        
        setTimeout(function() {
            btn.classList.remove('copied');
            text.textContent = 'üìã –ö–æ–ø–∏—Ä–∞–π Email';
        }, 2000);
    }).catch(function(err) {
        alert('Email: ' + email);
    });
}

// Close modal on ESC key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeEmailModal();
    }
});
</script>
<body>
	<header class="site-header">
		<a class="logo-link" href="index.html">
        <img src="assets/img/HistAdrLogo.png" alt="–ê–¥—Ä–µ—Å—ä—Ç –Ω–∞ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞" class="header-logo">
        <span class="logo-text">–ê–¥—Ä–µ—Å—ä—Ç –Ω–∞ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞</span>
    </a>
<nav class="nav">
    <a href="index.html">–ù–∞—á–∞–ª–æ</a>
    <a href="map.html">–ö–∞—Ä—Ç–∞</a>
    <a href="addresses.html">–î–æ–º–æ–≤–µ</a>
    <a href="calendar.html">–ö–∞–ª–µ–Ω–¥–∞—Ä</a>
    <a href="about.html">–ó–∞ –ù–∞—Å</a>
</nav>
		<button id="theme-toggle" class="theme-toggle" aria-label="Toggle dark mode"></button>
	</header>

	<div id="map" class="map-wrap" role="region" aria-label="Map of locations">
		<div id="loading" class="map-loading">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∫–∞—Ä—Ç–∞—Ç–∞</div>
	</div>

	<footer class="site-footer">
		<p>¬© <span id="year"></span> –ê–¥—Ä–µ—Å—ä—Ç –Ω–∞ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞</p>
		<div class="footer-social">
			<a href="https://instagram.com/historyaddress.bg" target="_blank" rel="noopener noreferrer" class="social-link">
				üì∑ Instagram
			</a>
			<a href="mailto:historyaddressbg@gmail.com" class="social-link" onclick="handleEmailClick(event)">
    üìß Email
</a>
		</div>
		<p class="footer-links">
			<a href="privacy.html">–ü–æ–≤–µ—Ä–∏—Ç–µ–ª–Ω–æ—Å—Ç</a> | 
			<a href="terms.html">–£—Å–ª–æ–≤–∏—è</a> | 
			<a href="copyright.html">–ê–≤—Ç–æ—Ä—Å–∫–∏ –ø—Ä–∞–≤–∞</a>
		</p>
	</footer>

	<script>
	window.addEventListener('DOMContentLoaded', function() {
		var params = new URLSearchParams(location.search);
		var targetSlug = params.get('slug');
		var loadingEl = document.getElementById('loading');
		var loadedData = false;

		var m = L.map('map', {
			zoomControl: true,
			worldCopyJump: true,
			maxBounds: [[-85, -180], [85, 180]],
			preferCanvas: true
		});
		
		var tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			maxZoom: 19,
			attribution: '&copy; OpenStreetMap contributors'
		});
		tiles.addTo(m);

		var markers = L.markerClusterGroup({
			maxClusterRadius: 50,
			spiderfyOnMaxZoom: true,
			showCoverageOnHover: false,
			zoomToBoundsOnClick: true,
			chunkedLoading: true,
			chunkInterval: 50,
			chunkDelay: 50
		});
		
		function createMarker(p) {

			var icon = L.divIcon({
				className: '',
				html: '<div class="logo-pin"></div>',
				iconSize: [40, 40],
				iconAnchor: [20, 20]
			});
			
			var marker = L.marker([Number(p.lat), Number(p.lng)], { icon: icon });
			marker.on('click', function(){ 
				location.href = 'address.html?slug=' + encodeURIComponent(p.slug || p.id); 
			});
			marker.bindTooltip(p.name, { direction: 'top', offset: [0,-24] });
			
			return marker;
		}
		
		function renderMarkers(homes){
			markers.clearLayers();
			
			var bounds = [];
			var focused = null;
			var validHomes = [];
			
			homes.forEach(function(p){
				if (!p.lat || !p.lng || !isFinite(p.lat) || !isFinite(p.lng)) {
					return;
				}
				validHomes.push(p);
				bounds.push([Number(p.lat), Number(p.lng)]);
			});
			
			console.log('Rendering', validHomes.length, 'markers with logo');
			
			var batchSize = 25;
			var currentBatch = 0;
			
			function addBatch() {
				var start = currentBatch * batchSize;
				var end = Math.min(start + batchSize, validHomes.length);
				
				for (var i = start; i < end; i++) {
					var p = validHomes[i];
					var marker = createMarker(p);
					markers.addLayer(marker);
					
					if (targetSlug && (p.slug === targetSlug || p.id === targetSlug)) {
						focused = { lat: p.lat, lng: p.lng, marker: marker };
					}
				}
				
				currentBatch++;
				
				if (loadingEl && end < validHomes.length) {
					var percent = Math.round((end / validHomes.length) * 100);
					loadingEl.textContent = '–ó–∞—Ä–µ–∂–¥–∞–Ω–µ ' + percent + '%';
				}
				
				if (end < validHomes.length) {
					setTimeout(addBatch, 10);
				} else {
					m.addLayer(markers);
					
					if (bounds.length) {
						m.fitBounds(bounds, { padding: [20,20] });
					} else {
						m.setView([42.7, 25.5], 7);
					}
					
					if (focused) {
						setTimeout(function() {
							m.setView([focused.lat, focused.lng], Math.max(m.getZoom(), 15));
							focused.marker.openTooltip();
						}, 300);
					}
					
					if (loadingEl) {
						setTimeout(function() {
							loadingEl.style.display = 'none';
						}, 300);
					}
					
					console.log('‚úÖ Map loaded with logo markers');
				}
			}
			
			addBatch();
		}
		
		function setDynamicMinZoom(){
			var w = m.getSize().x;
			var target = Math.ceil(Math.log2(Math.max(1, w / 256)));
			m.setMinZoom(target);
		}
		setDynamicMinZoom();
		window.addEventListener('resize', function(){ setDynamicMinZoom(); });
		
		function loadHomes() {
			if (loadedData) return;
			loadedData = true;
			
			var apiBase = window.location.protocol === 'file:' ? 'http://localhost:3000' : window.location.origin;
			
			if (loadingEl) loadingEl.style.display = 'block';
			
			fetch(apiBase + '/api/homes/map')
				.then(function(res){ 
					if (!res.ok) throw new Error('Network error');
					return res.json(); 
				})
				.then(function(homes){
					console.log('üìç Loaded', homes.length, 'homes');
					renderMarkers(homes);
				})
				.catch(function(err){
					console.error('‚ùå Error:', err);
					m.setView([42.7, 25.5], 7);
					if (loadingEl) {
						loadingEl.textContent = '–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ';
						loadingEl.style.backgroundColor = 'rgba(220, 38, 38, 0.9)';
						setTimeout(function() {
							loadingEl.style.display = 'none';
						}, 3000);
					}
				});
		}
		
		loadHomes();
		document.getElementById('year').textContent = new Date().getFullYear();
	});
	</script>
</body>
</html>
