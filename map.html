<!doctype html>
<html lang="en" data-theme="dark">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Адресът на историята - Карта</title>
	<meta name="description" content="Map of historic addresses.">
	<link rel="icon" href="/assets/img/HistAdrLogoOrig.ico">
	<script>
		// Apply theme immediately to prevent flash
		(function() {
			try {
				var stored = localStorage.getItem('theme-preference');
				if (stored === 'system') stored = 'dark';
				var theme = (stored === 'dark' || stored === 'light') ? stored : 'dark';
				document.documentElement.setAttribute('data-theme', theme);
			} catch(e) {}
		})();
	</script>
	<link rel="stylesheet" href="assets/css/styles.css">
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
	<script defer src="assets/js/theme.js"></script>
	<script defer src="assets/js/transitions.js"></script>
	<script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>
<body>
	<header class="site-header">
		<a class="logo-link" href="index.html">
        <img src="assets/img/HistAdrLogo.png" alt="Адресът на историята" class="header-logo">
        <span class="logo-text">Адресът на историята</span>
    </a>
		<nav class="nav">
			<a href="index.html">Начало</a>
			<a href="map.html">Карта</a>
			<a href="addresses.html">Домове</a>
			<a href="about.html">За Нас</a>
		</nav>
		<button id="theme-toggle" class="theme-toggle" aria-label="Toggle dark mode"></button>
	</header>

	<div id="map" class="map-wrap" role="region" aria-label="Map of locations"></div>

	<footer class="site-footer">
		<p>© <span id="year"></span> Адресът на историята</p>
	</footer>

	<script>
	window.addEventListener('DOMContentLoaded', function() {
		var params = new URLSearchParams(location.search);
		var targetSlug = params.get('slug');

		var m = L.map('map', {
			zoomControl: true,
			worldCopyJump: true,
			maxBounds: [[-85, -180], [85, 180]]
		});
		var tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			maxZoom: 19,
			attribution: '&copy; OpenStreetMap contributors'
		});
		tiles.addTo(m);

		var markersLayer = L.layerGroup().addTo(m);
		
		function renderMarkers(people){
			markersLayer.clearLayers();
			var bounds = [];
			var placeholder = 'assets/img/placeholder.svg';
			var focused = null;
			people.forEach(function(p){
				var ll = [Number(p.coordinates.lat), Number(p.coordinates.lng)];
				bounds.push(ll);
				
				// Use thumbnail if available for faster loading
				var img = placeholder;
				if (p.images && p.images[0]) {
					img = p.images[0].thumb || p.images[0].path || placeholder;
				}
				
				var icon = L.divIcon({
					className: '',
					html: '<div class="pin" style="background-image:url(\'' + img.replace(/"/g,'&quot;') + '\')"></div>',
					iconSize: [44,44],
					iconAnchor: [22,22]
				});
				var marker = L.marker(ll, { icon: icon }).addTo(markersLayer);
				marker.on('click', function(){ location.href = 'address.html?slug=' + encodeURIComponent(p.slug||p.id); });
				marker.bindTooltip(p.name, { direction: 'top', offset: [0,-24] });
				if (targetSlug && (p.slug === targetSlug || p.id === targetSlug)) { focused = { ll: ll, marker: marker }; }
			});
			if (bounds.length) { m.fitBounds(bounds, { padding: [20,20] }); }
			if (focused) { m.setView(focused.ll, Math.max(m.getZoom(), 15)); focused.marker.openTooltip(); }
		}
		
		function setDynamicMinZoom(){
			var w = m.getSize().x;
			var target = Math.ceil(Math.log2(Math.max(1, w / 256)));
			m.setMinZoom(target);
		}
		setDynamicMinZoom();
		window.addEventListener('resize', function(){ setDynamicMinZoom(); });
		
		// Fetch ALL homes from API (no pagination for map)
		function loadHomes() {
			var apiBase = window.location.protocol === 'file:' ? 'http://localhost:3000' : window.location.origin;
			
			// Request all homes with a very high limit to get everything at once
			fetch(apiBase + '/api/homes?limit=1000')
				.then(function(res){ 
					if (!res.ok) {
						throw new Error('Network response was not ok');
					}
					return res.json(); 
				})
				.then(function(response){
					// Handle new paginated response format
					var allHomes = response.data || response;
					
					// If there are more pages, fetch them too
					if (response.pagination && response.pagination.totalPages > 1) {
						console.log('Fetching all', response.pagination.total, 'homes for map...');
						var promises = [];
						for (var page = 2; page <= response.pagination.totalPages; page++) {
							promises.push(
								fetch(apiBase + '/api/homes?limit=1000&page=' + page)
									.then(function(res){ return res.json(); })
									.then(function(resp){ return resp.data || resp; })
							);
						}
						return Promise.all(promises).then(function(results){
							results.forEach(function(homes){
								allHomes = allHomes.concat(homes);
							});
							return allHomes;
						});
					}
					return allHomes;
				})
				.then(function(allHomes){
					// Filter only published homes with valid coordinates
					var people = allHomes.filter(function(p){
						return p && p.published && p.coordinates && isFinite(p.coordinates.lat) && isFinite(p.coordinates.lng);
					});
					
					console.log('Loaded', people.length, 'homes with coordinates');
					renderMarkers(people);
					
					if (!people.length) { 
						m.setView([42.7, 25.5], 7); // Center on Bulgaria
					}
				})
				.catch(function(err){
					console.error('Error loading homes:', err);
					m.setView([42.7, 25.5], 7); // Center on Bulgaria
				});
		}
		
		loadHomes();
		// Refresh map when tab becomes visible
		document.addEventListener('visibilitychange', function(){ if (!document.hidden) loadHomes(); });
		document.getElementById('year').textContent = new Date().getFullYear();
	});
	</script>
</body>
</html>
